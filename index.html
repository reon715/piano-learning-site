<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Piano Learning App - Twinkle Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  color: white;
  margin: 0;
  padding: 0;
}

h1 {
  margin-top: 15px;
}

#hud {
  font-size: 18px;
  font-weight: bold;
  margin: 10px;
}

button {
  padding: 10px 18px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  margin: 5px;
  cursor: pointer;
}

button:hover {
  opacity: 0.85;
}

.piano {
  position: relative;
  width: 720px;
  height: 260px;
  margin: 20px auto;
}

.key {
  position: absolute;
  bottom: 0;
  border: 1px solid black;
  cursor: pointer;
}

.white {
  width: 60px;
  height: 240px;
  background: white;
  z-index: 1;
}

.black {
  width: 40px;
  height: 150px;
  background: black;
  position: absolute;
  top: 0;
  z-index: 3;
  border-radius: 0 0 6px 6px;
}


.key.guide {
  background: gold !important;
  box-shadow: 0 0 20px gold;
}

.key.demo {
  background: #4fc3f7 !important;
}

</style>
</head>

<body>

<h1>üéπ Piano Learning App</h1>

<div id="hud">
Score: <span id="score">0</span> |
Combo: <span id="combo">0</span>
</div>

<button onclick="startTwinkle()">Start Twinkle ‚≠ê</button>
<button onclick="playDemo()">Play Demo üé∂</button>

<div class="piano" id="piano"></div>

<script>
const notes = [
"C4","D4","E4","F4","G4","A4","B4",
"C5","D5","E5","F5","G5","A5","B5"
];

const blackNotes = ["C#4","D#4","F#4","G#4","A#4","C#5","D#5","F#5","G#5","A#5"];

const piano = document.getElementById("piano");

// Create white keys
notes.forEach((note, i) => {
  const key = document.createElement("div");
  key.className = "key white";
  key.dataset.note = note;
  key.style.left = (i * 60) + "px";
  key.onclick = () => playNote(note);
  piano.appendChild(key);
});

// Create black keys
const blackPositions = {
  "C#4": 40, "D#4": 100,
  "F#4": 220, "G#4": 280, "A#4": 340,
  "C#5": 460, "D#5": 520,
  "F#5": 640, "G#5": 700, "A#5": 760
};

blackNotes.forEach(note => {
  const key = document.createElement("div");
  key.className = "key black";
  key.dataset.note = note;
  key.style.left = blackPositions[note] + "px";
  key.onclick = () => playNote(note);
  piano.appendChild(key);
});

// Sound system
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function frequency(note) {
  const map = {
    "C4":261.63,"C#4":277.18,"D4":293.66,"D#4":311.13,"E4":329.63,"F4":349.23,
    "F#4":369.99,"G4":392.00,"G#4":415.30,"A4":440.00,"A#4":466.16,"B4":493.88,
    "C5":523.25,"C#5":554.37,"D5":587.33,"D#5":622.25,"E5":659.25,"F5":698.46,
    "F#5":739.99,"G5":783.99,"G#5":830.61,"A5":880.00,"A#5":932.33,"B5":987.77
  };
  return map[note];
}

function playNote(note) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.value = frequency(note);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.6);
  osc.stop(audioCtx.currentTime + 0.6);

  handleTwinkleInput(note);
}

// Twinkle Mode Data
const twinkleNotes = [
"C4","C4","G4","G4","A4","A4","G4",
"F4","F4","E4","E4","D4","D4","C4"
];

let currentIndex = 0;
let score = 0;
let combo = 0;

// Update guide
function updateGuide() {
  document.querySelectorAll(".key").forEach(k => k.classList.remove("guide"));
  const note = twinkleNotes[currentIndex];
  const key = document.querySelector(`.key[data-note="${note}"]`);
  if (key) key.classList.add("guide");
}

// Start mode
function startTwinkle() {
  currentIndex = 0;
  score = 0;
  combo = 0;
  updateHUD();
  updateGuide();
}

// HUD update
function updateHUD() {
  document.getElementById("score").textContent = score;
  document.getElementById("combo").textContent = combo;
}

// Input judge
function handleTwinkleInput(note) {
  const expected = twinkleNotes[currentIndex];
  if (!expected) return;

  if (note === expected) {
    score += 100 + combo * 5;
    combo++;
    currentIndex++;
    updateGuide();

    if (currentIndex >= twinkleNotes.length) {
      showResult();
    }
  } else {
    combo = 0;
  }

  updateHUD();
}

// Demo mode
function playDemo() {
  let i = 0;
  const interval = setInterval(() => {
    const note = twinkleNotes[i];
    const key = document.querySelector(`.key[data-note="${note}"]`);

    if (key) key.classList.add("demo");
    playNote(note);

    setTimeout(() => {
      if (key) key.classList.remove("demo");
    }, 300);

    i++;
    if (i >= twinkleNotes.length) clearInterval(interval);
  }, 500);
}

// Result
function showResult() {
  let rank = "C";
  if (score > 1200) rank = "A";
  if (score > 1600) rank = "S";

  alert(`üéâ Twinkle Complete!\nScore: ${score}\nRank: ${rank}`);
}

</script>
</body>
</html>
